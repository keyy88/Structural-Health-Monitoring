#include <Arduino.h>
#include <driver/i2s.h>
// #include <TensorFlowLite_ESP32.h>
// #include "secret.h"
// #include "WiFi.h"
#include "ThingSpeak.h"

// Serial config
#define BAUDRATE    115200    // Baud rate

#define SECRET_SSID "Asus_Lab Instrumentasi"
#define SECRET_PASS "123456789"

#define SECRET_CH_ID 2260393
#define SECRET_WRITE_APIKEY "U1139IB2WTCO2TN7"

// Pulse config
#define PWM_PIN     5         // PWM pin
#define PWM_FREQ    5000      // PWM freq (Hz)
#define PWM_BITS    10        // PWM resolution
#define PWM_CHANNEL 0         // PWM Channel
#define PWM_DUTY    512       // PWM duty cycle
#define BURST_PULSE 1         // Pulse cycle count
#define DT          24000000  // Delay (1000ms)

//Interrupt pin
#define INT_PIN     18        // Interrupt pin (falling edge)

//ADC I2S configuration
#define I2S_SAMPLE_RATE     50000                             // Sampling freq ADC (Hz)
#define I2S_TS              (1000000/I2S_SAMPLE_RATE)         // Sampling time (us)
#define I2S_DMA_BUF_LEN     1024                              // I2S ADC buffer size
#define I2S_DMA_BUF_ARR     2                                 // I2S ADC buffer array size
#define I2S_DMA_BUF_FLATTEN (I2S_DMA_BUF_LEN*I2S_DMA_BUF_ARR) // Total buffer data size
#define ADC_INPUT           ADC1_CHANNEL_4                    // ADC Channel
#define VREF                3.3                               // ESP32 voltage reference
#define B_PASS_COEF         55                                // Band-pass filter coefficient size

size_t bytes_read;
uint8_t cnt;                                                  // Burst count
uint16_t buffer[I2S_DMA_BUF_ARR][I2S_DMA_BUF_LEN] = {0};
float buff[I2S_DMA_BUF_FLATTEN + (2 * B_PASS_COEF)] = {0};
float buff_filtered[I2S_DMA_BUF_FLATTEN] = {0.0};
unsigned long prev,curr;

// Feature extraction
#define FEATURE_EXTRACT
float miu, sigma_sqr;   // Mean and variance,
uint16_t tetha;         // Time of flight

// Thingspeak WiFi & API
#define IOT
char ssid[] = SECRET_SSID;                        //WiFi SSID
char pass[] = SECRET_PASS;                        //WiFi Password
unsigned long myChannelNumber = SECRET_CH_ID;     //Thingspeak CH ID
const char * myWriteAPIKey = SECRET_WRITE_APIKEY; //Thingspeak Write API key
// WiFiClient client;

// Neural network
#define NN
float dmg_index;

// Reference signal
const float ref_signal[I2S_DMA_BUF_FLATTEN]={-23.79,
-10.70,
3.64,
11.48,
14.67,
16.52,
15.02,
8.34,
1.43,
2.98,
14.64,
25.93,
23.50,
4.81,
-18.49,
-31.18,
-26.97,
-11.82,
1.34,
1.63,
-10.05,
-20.08,
-16.05,
0.09,
15.66,
22.13,
19.38,
8.71,
-6.98,
-17.34,
-11.93,
4.91,
16.10,
11.33,
-1.34,
-7.36,
-3.76,
-0.96,
-7.47,
-17.27,
-16.17,
0.01,
18.66,
23.73,
13.68,
3.34,
6.66,
21.21,
30.85,
23.79,
4.82,
-11.36,
-16.40,
-16.06,
-21.68,
-37.21,
-54.46,
-63.13,
-61.92,
-59.08,
-59.46,
-56.54,
-40.41,
-11.78,
18.99,
46.23,
73.55,
105.01,
135.58,
157.22,
167.61,
171.43,
168.95,
152.00,
114.93,
67.56,
25.85,
-9.33,
-53.29,
-117.11,
-190.67,
-253.72,
-294.78,
-318.78,
-331.82,
-329.78,
-303.16,
-252.95,
-189.28,
-116.75,
-31.77,
65.46,
162.40,
245.62,
311.73,
366.76,
411.18,
435.13,
428.73,
396.30,
350.93,
296.79,
225.62,
130.80,
21.28,
-85.77,
-179.13,
-259.75,
-328.65,
-379.05,
-403.72,
-407.39,
-398.72,
-372.93,
-318.27,
-237.44,
-151.89,
-77.48,
-10.63,
61.53,
139.56,
210.66,
262.63,
295.39,
313.08,
311.96,
286.40,
242.78,
196.00,
149.22,
92.57,
19.95,
-57.50,
-124.26,
-174.69,
-214.54,
-246.01,
-261.63,
-253.58,
-225.74,
-187.74,
-139.26,
-74.45,
2.20,
72.07,
122.83,
158.83,
192.27,
223.79,
241.35,
234.55,
206.21,
165.86,
115.88,
55.55,
-7.65,
-60.15,
-100.62,
-139.36,
-181.73,
-216.27,
-227.32,
-211.22,
-177.13,
-134.13,
-81.82,
-19.06,
47.59,
107.27,
159.99,
210.29,
253.22,
271.37,
254.72,
211.64,
158.82,
103.45,
39.03,
-39.21,
-125.46,
-207.42,
-280.46,
-340.68,
-375.63,
-371.69,
-336.13,
-292.32,
-253.31,
-208.19,
-138.73,
-43.15,
63.77,
165.35,
255.05,
330.32,
386.02,
418.60,
437.02,
451.78,
457.28,
433.55,
370.11,
278.24,
176.97,
74.59,
-32.56,
-145.38,
-255.91,
-354.12,
-439.62,
-512.92,
-563.65,
-575.23,
-545.32,
-488.33,
-417.28,
-331.18,
-222.63,
-94.16,
42.48,
175.76,
302.76,
418.06,
507.69,
558.84,
578.09,
581.04,
567.88,
520.48,
426.33,
296.39,
152.28,
9.18,
-129.85,
-261.24,
-378.19,
-474.07,
-550.64,
-606.55,
-627.60,
-596.96,
-517.26,
-411.79,
-300.06,
-184.07,
-56.14,
81.61,
217.88,
340.10,
443.42,
522.95,
569.73,
577.92,
555.96,
516.29,
456.33,
363.35,
236.09,
94.01,
-43.21,
-169.16,
-287.53,
-395.20,
-482.27,
-540.04,
-568.97,
-570.17,
-536.76,
-462.60,
-356.48,
-239.59,
-123.91,
-7.18,
115.12,
234.48,
337.24,
416.04,
473.74,
511.37,
521.34,
496.84,
444.33,
377.87,
300.90,
207.11,
95.67,
-20.56,
-129.60,
-228.56,
-319.03,
-395.19,
-446.39,
-467.36,
-463.76,
-442.52,
-400.80,
-332.77,
-242.51,
-144.67,
-47.58,
49.84,
148.47,
238.93,
309.83,
357.14,
385.01,
395.94,
386.17,
353.15,
302.66,
243.62,
175.43,
93.20,
0.67,
-87.01,
-159.70,
-219.40,
-272.36,
-315.83,
-340.06,
-339.54,
-319.01,
-285.74,
-239.44,
-178.02,
-107.19,
-38.07,
27.75,
95.63,
164.08,
219.77,
252.44,
265.41,
268.92,
266.29,
251.12,
219.29,
176.37,
130.78,
81.51,
24.84,
-32.44,
-77.01,
-108.21,
-139.08,
-177.35,
-213.31,
-231.79,
-229.61,
-216.41,
-200.21,
-178.05,
-144.26,
-101.93,
-58.21,
-10.98,
45.27,
104.07,
149.35,
176.68,
197.28,
220.01,
237.18,
234.67,
209.42,
171.62,
131.24,
87.02,
34.71,
-21.52,
-72.54,
-118.63,
-164.87,
-206.31,
-228.80,
-228.52,
-216.85,
-203.98,
-185.79,
-151.29,
-99.14,
-39.34,
18.20,
73.59,
127.42,
171.25,
195.96,
208.58,
222.24,
233.90,
226.68,
195.43,
153.60,
111.56,
64.65,
5.74,
-58.50,
-113.84,
-154.23,
-186.97,
-217.16,
-236.12,
-232.32,
-210.81,
-188.25,
-169.43,
-142.59,
-98.73,
-45.88,
2.06,
40.91,
76.71,
112.73,
143.22,
162.16,
173.01,
182.06,
185.28,
173.61,
149.01,
124.08,
103.33,
77.77,
39.64,
-4.25,
-40.22,
-62.98,
-79.26,
-95.07,
-106.06,
-106.07,
-99.26,
-94.31,
-87.23,
-66.63,
-33.19,
-4.10,
7.88,
7.48,
7.53,
11.69,
13.14,
6.94,
-3.15,
-12.09,
-23.88,
-42.51,
-59.56,
-61.15,
-48.53,
-35.99,
-29.96,
-21.88,
-4.53,
17.33,
36.63,
54.71,
77.30,
102.18,
118.80,
121.64,
120.13,
125.48,
132.92,
125.83,
98.54,
63.05,
31.92,
3.36,
-32.02,
-75.08,
-115.86,
-146.11,
-169.59,
-192.43,
-210.06,
-210.77,
-194.32,
-173.55,
-156.21,
-131.88,
-81.93,
-2.71,
87.29,
160.22,
201.74,
219.21,
230.22,
240.89,
240.97,
219.89,
183.20,
146.73,
115.20,
78.18,
25.59,
-37.39,
-96.73,
-143.90,
-181.00,
-210.69,
-229.46,
-234.07,
-230.64,
-225.33,
-209.73,
-169.73,
-107.97,
-45.77,
1.33,
37.93,
77.19,
121.48,
161.74,
190.29,
208.55,
219.10,
216.57,
196.15,
166.28,
140.98,
119.80,
89.59,
45.48,
-0.97,
-38.51,
-68.69,
-98.25,
-125.56,
-141.38,
-142.49,
-137.36,
-134.60,
-128.83,
-109.59,
-79.10,
-52.20,
-36.21,
-24.59,
-10.54,
2.26,
7.00,
4.63,
1.56,
0.57,
-3.29,
-12.32,
-20.16,
-19.03,
-12.61,
-8.36,
-2.20,
18.11,
52.90,
86.86,
108.14,
120.58,
135.07,
153.02,
166.48,
168.75,
161.81,
147.73,
121.12,
77.70,
27.48,
-15.04,
-51.21,
-94.47,
-147.66,
-197.21,
-233.54,
-260.61,
-283.83,
-296.09,
-285.84,
-252.52,
-208.99,
-164.22,
-110.53,
-36.58,
51.72,
132.99,
195.20,
244.55,
290.91,
331.36,
355.76,
359.32,
345.86,
318.29,
272.62,
206.47,
128.45,
51.44,
-23.25,
-102.55,
-185.65,
-258.93,
-312.34,
-348.30,
-373.80,
-386.76,
-377.19,
-340.01,
-282.10,
-214.31,
-139.53,
-57.67,
24.93,
98.96,
166.95,
236.61,
302.89,
346.81,
356.96,
341.41,
315.05,
282.80,
239.25,
182.90,
120.99,
60.26,
-4.02,
-76.28,
-145.65,
-194.39,
-221.39,
-241.80,
-263.18,
-275.91,
-269.92,
-249.12,
-223.07,
-193.24,
-152.66,
-99.10,
-41.49,
9.75,
55.26,
101.50,
147.30,
184.89,
213.81,
240.14,
262.03,
267.72,
250.79,
219.07,
184.43,
149.85,
110.21,
63.94,
17.16,
-25.34,
-68.52,
-117.43,
-163.48,
-192.48,
-204.57,
-213.95,
-227.52,
-236.09,
-229.29,
-209.40,
-185.74,
-161.19,
-130.17,
-88.87,
-42.66,
1.45,
44.51,
90.90,
136.39,
172.40,
200.62,
230.68,
262.67,
282.90,
280.72,
260.48,
234.26,
206.54,
172.29,
127.19,
74.83,
19.79,
-40.87,
-109.44,
-175.20,
-222.99,
-253.51,
-280.96,
-310.69,
-330.67,
-329.06,
-308.56,
-279.40,
-243.88,
-195.23,
-130.81,
-60.04,
6.65,
72.05,
144.24,
218.63,
279.44,
320.36,
348.74,
369.38,
374.85,
356.83,
317.73,
266.65,
208.45,
141.01,
64.30,
-15.22,
-91.02,
-165.33,
-239.72,
-302.68,
-337.35,
-343.25,
-337.46,
-332.58,
-322.30,
-292.10,
-238.79,
-172.37,
-103.29,
-32.38,
40.84,
108.58,
162.07,
206.63,
253.17,
297.58,
321.55,
316.08,
291.72,
261.82,
227.39,
181.96,
126.42,
69.78,
17.80,
-34.67,
-91.76,
-143.78,
-176.46,
-190.95,
-201.93,
-215.14,
-220.51,
-208.40,
-183.81,
-157.45,
-131.91,
-100.73,
-61.90,
-24.17,
3.67,
25.79,
51.99,
80.40,
99.42,
105.50,
108.15,
113.65,
116.36,
107.98,
90.73,
74.22,
63.86,
55.45,
44.45,
34.32,
30.10,
27.63,
19.09,
8.09,
5.32,
10.99,
11.43,
-2.49,
-24.73,
-43.91,
-57.79,
-72.72,
-91.64,
-109.02,
-119.10,
-125.28,
-131.91,
-132.19,
-114.38,
-80.70,
-47.46,
-25.08,
-6.61,
20.49,
57.13,
92.92,
119.92,
140.85,
159.62,
170.96,
167.89,
156.26,
147.67,
140.17,
119.74,
81.95,
39.15,
2.91,
-29.06,
-64.82,
-103.36,
-135.16,
-154.67,
-166.99,
-177.46,
-180.27,
-166.35,
-139.28,
-112.61,
-90.71,
-64.87,
-29.20,
8.45,
36.73,
54.84,
71.63,
91.84,
108.75,
114.45,
112.05,
110.82,
110.72,
103.01,
84.96,
64.72,
48.63,
33.03,
11.49,
-14.20,
-35.82,
-49.30,
-59.64,
-71.77,
-81.22,
-80.32,
-71.02,
-62.70,
-57.19,
-46.80,
-27.45,
-6.25,
8.37,
17.06,
27.14,
40.94,
52.28,
55.63,
54.75,
55.49,
54.20,
42.98,
24.86,
11.96,
7.47,
0.74,
-17.79,
-43.39,
-63.89,
-73.72,
-77.71,
-80.45,
-78.91,
-68.87,
-54.90,
-44.33,
-33.36,
-10.94,
23.52,
55.29,
71.29,
74.45,
78.18,
88.80,
99.61,
101.68,
95.63,
86.63,
72.71,
48.66,
19.55,
-2.39,
-15.51,
-31.47,
-58.65,
-90.08,
-112.96,
-122.86,
-125.13,
-123.55,
-114.46,
-94.88,
-71.24,
-51.12,
-29.16,
5.51,
50.14,
86.84,
104.29,
109.37,
115.44,
124.70,
128.31,
120.00,
103.24,
83.12,
56.43,
19.81,
-17.68,
-41.77,
-53.53,
-68.76,
-96.35,
-126.01,
-142.14,
-141.21,
-131.32,
-118.51,
-100.48,
-75.30,
-49.43,
-29.02,
-6.44,
30.36,
77.42,
114.58,
129.20,
128.88,
128.48,
131.63,
130.48,
119.11,
100.44,
79.05,
52.41,
18.38,
-13.71,
-30.78,
-35.18,
-44.12,
-67.93,
-97.02,
-114.02,
-113.53,
-104.24,
-95.16,
-85.39,
-71.45,
-57.70,
-50.01,
-41.83,
-21.19,
9.65,
33.83,
41.40,
40.39,
43.24,
51.61,
58.61,
60.95,
61.95,
63.24,
59.02,
45.94,
33.35,
32.71,
39.09,
35.29,
15.09,
-9.61,
-26.53,
-36.25,
-46.77,
-62.86,
-83.59,
-100.74,
-101.04,
-78.36,
-44.20,
-17.76,
-4.93,
5.12,
23.42,
46.96,
65.58,
75.36,
81.51,
87.57,
88.48,
79.19,
65.58,
57.39,
52.56,
39.76,
16.39,
-6.87,
-21.67,
-32.58,
-48.48,
-69.11,
-85.66,
-92.75,
-95.03,
-98.04,
-97.91,
-87.67,
-70.72,
-57.31,
-48.24,
-34.07,
-11.24,
11.06,
23.58,
28.98,
36.63,
49.83,
62.33,
68.76,
72.46,
78.95,
85.01,
83.69,
78.01,
78.20,
85.51,
88.11,
76.80,
55.99,
36.92,
23.31,
9.55,
-9.43,
-31.05,
-51.48,
-74.03,
-102.57,
-129.37,
-140.70,
-135.60,
-128.38,
-131.02,
-138.71,
-137.75,
-121.74,
-96.23,
-67.77,
-35.39,
3.11,
41.43,
71.93,
100.00,
136.87,
179.60,
209.47,
214.16,
200.77,
184.21,
168.97,
148.21,
117.04,
79.66,
41.49,
-0.70,
-50.52,
-98.27,
-127.62,
-137.14,
-143.79,
-161.93,
-185.87,
-197.51,
-187.43,
-162.52,
-134.48,
-106.00,
-74.27,
-42.08,
-14.82,
11.64,
45.68,
83.31,
109.42,
117.40,
117.24,
120.09,
124.60,
121.67,
109.13,
94.04,
82.03,
68.64,
48.78,
29.03,
20.28,
20.17,
14.72,
-1.36,
-18.45,
-26.85,
-29.97,
-36.73,
-48.95,
-60.33,
-67.75,
-76.42,
-89.99,
-100.49,
-97.80,
-86.67,
-81.50,
-85.52,
-85.79,
-72.08,
-49.34,
-28.64,
-11.78,
8.23,
34.52,
60.06,
78.19,
94.33,
117.72,
144.81,
160.80,
159.34,
149.15,
140.11,
130.00,
110.27,
78.84,
42.65,
7.92,
-27.26,
-66.02,
-103.53,
-131.74,
-151.80,
-170.76,
-187.51,
-192.24,
-181.70,
-164.53,
-148.99,
-132.29,
-105.95,
-68.01,
-25.22,
16.16,
56.94,
97.90,
131.96,
152.68,
167.81,
190.03,
215.97,
226.76,
211.91,
181.09,
149.54,
120.66,
87.90,
48.29,
6.78,
-32.80,
-75.08,
-123.03,
-165.76,
-188.30,
-192.22,
-193.72,
-201.16,
-206.29,
-199.27,
-181.06,
-156.86,
-126.59,
-87.57,
-43.34,
-3.73,
27.44,
59.59,
102.97,
151.91,
189.29,
207.37,
214.33,
219.26,
219.68,
207.73,
182.54,
150.96,
117.69,
79.48,
33.56,
-13.54,
-52.47,
-84.72,
-119.06,
-155.51,
-182.93,
-194.23,
-194.85,
-193.09,
-188.76,
-175.23,
-150.07,
-118.23,
-84.59,
-46.91,
-2.75,
41.28,
75.09,
99.54,
124.21,
151.24,
170.20,
171.69,
159.33,
143.77,
129.54,
111.46,
85.14,
54.63,
26.54,
-0.45,
-30.31,
-57.58,
-71.74,
-74.04,
-78.53,
-93.60,
-110.99,
-116.27,
-106.20,
-90.16,
-77.03,
-65.76,
-52.26,
-39.59,
-32.07,
-22.66,
0.24,
33.64,
59.91,
67.79,
64.57,
63.98,
69.93,
76.51,
79.18,
79.67,
78.97,
71.29,
52.98,
33.10,
23.76,
21.58,
10.61,
-15.42,
-44.52,
-63.06,
-71.57,
-80.07,
-92.35,
-101.91,
-102.71,
-98.63,
-95.00,
-86.39,
-63.61,
-30.83,
-3.24,
13.48,
29.30,
53.75,
82.17,
103.34,
113.78,
119.56,
124.49,
123.30,
111.02,
94.38,
83.34,
74.43,
54.63,
21.52,
-12.42,
-37.53,
-58.03,
-82.08,
-108.12,
-127.33,
-135.81,
-139.11,
-141.71,
-137.42,
-117.97,
-87.90,
-61.29,
-43.34,
-25.90,
-1.68,
25.38,
47.47,
63.52,
77.80,
91.08,
97.89,
95.78,
92.06,
95.30,
101.81,
99.75,
85.82,
69.62,
59.74,
52.79,
40.24,
20.85,
1.91,
-12.37,
-27.50,
-49.20,
-71.17,
-82.47,
-84.09,
-87.58,
-97.15,
-104.57,
-103.42,
-97.98,
-94.62,
-91.28,
-81.08,
-62.81,
-43.57,
-28.05,
-10.73,
15.86,
47.57,
72.36,
86.72,
98.97,
115.14,
129.46,
132.70,
124.68,
113.76,
104.80,
92.60,
71.28,
45.47,
24.52,
7.97,
-12.95,
-39.98,
-64.20,
-79.46,
-90.40,
-103.62,
-116.95,
-122.08,
-116.09,
-105.38,
-95.88,
-83.42,
-60.80,
-31.10,
-5.52,
12.15,
28.63,
48.44,
66.18,
74.91,
76.19,
77.17,
80.23,
79.55,
70.92,
59.58,
52.66,
47.05,
34.88,
18.87,
10.11,
10.45,
8.05,
-6.06,
-26.20,
-40.14,
-44.65,
-47.37,
-54.51,
-62.43,
-65.33,
-66.34,
-71.41,
-75.40,
-66.75,
-46.27,
-29.10,
-25.47,
-27.90,
-22.05,
-4.40,
15.67,
30.09,
41.50,
55.23,
67.43,
71.58,
73.36,
84.69,
103.82,
113.67,
103.39,
80.91,
60.96,
47.31,
32.77,
12.54,
-9.06,
-27.52,
-47.82,
-75.53,
-102.13,
-112.18,
-104.95,
-97.14,
-101.62,
-112.12,
-113.31,
-99.69,
-79.09,
-59.62,
-40.06,
-16.68,
6.08,
22.41,
38.95,
67.51,
104.64,
131.34,
135.89,
126.83,
119.58,
117.80,
113.23,
99.92,
81.69,
63.62,
42.01,
11.94,
-19.12,
-37.72,
-43.97,
-53.26,
-75.83,
-103.74,
-121.81,
-125.41,
-122.01,
-118.07,
-110.56,
-95.02,
-76.43,
-62.69,
-49.92,
-26.70,
7.45,
38.28,
54.47,
60.38,
67.42,
78.77,
87.37,
88.09,
84.96,
83.12,
78.46,
65.66,
51.19,
44.89,
40.74,
23.65,
-6.14,
-31.74,
-42.98,
-44.35,
-40.58,
-32.64,
-27.51,
-33.22,
-41.86,
-36.77,
-16.96,
-1.04,
-2.42,
-14.17,
-21.65,
-20.94,
-18.95,
-20.27,
-21.52,
-19.63,
-20.07,
-27.32,
-32.60,
-22.73,
-0.33,
17.79,
23.05,
23.98,
30.75,
41.36,
48.01,
49.36,
51.11,
55.25,
55.14,
45.47,
32.72,
27.00,
26.25,
18.54,
0.09,
-19.53,
-32.07,
-41.00,
-54.07,
-70.89,
-83.49,
-86.81,
-84.66,
-81.69,
-74.78,
-58.69,
-37.43,
-19.94,
-5.31,
16.21,
46.89,
74.98,
88.72,
89.93,
90.01,
94.53,
97.39,
91.40,
79.16,
66.85,
51.67,
27.18,
-1.38,
-20.50,
-28.20,
-37.70,
-59.12,
-86.14,
-105.45,
-112.10,
-111.38,
-108.04,
-100.24,
-85.89,
-70.32,
-58.73,
-44.32,
-15.80,
24.52,
59.91,
79.02,
86.82,
94.03,
102.66,
107.04,
104.53,
99.36,
94.29,
83.73,
63.09,
40.29,
26.83,
19.62,
4.45,
-22.42,
-49.01,
-65.54,
-76.11,
-88.99,
-103.42,
-111.73,
-110.70,
-105.42,
-100.06,
-89.81,
-68.16,
-39.17,
-14.10,
4.01,
22.70,
46.82,
70.28,
84.82,
90.80,
95.30,
101.07,
102.17,
93.54,
79.83,
68.56,
57.37,
38.37,
13.34,
-6.58,
-17.53,
-28.45,
-47.56,
-70.46,
-86.24,
-90.87,
-90.08,
-88.92,
-84.40,
-72.97,
-60.09,
-52.65,
-44.23,
-21.81,
13.03,
41.21,
48.11,
40.48,
37.04,
46.66,
61.26,
69.46,
70.06,
67.81,
60.86,
45.56,
29.94,
27.33,
36.21,
39.90,
28.48,
9.61,
-5.04,
-14.64,
-25.31,
-38.19,
-47.75,
-52.21,
-59.14,
-73.49,
-85.32,
-80.84,
-63.40,
-50.80,
-51.51,
-55.06,
-49.10,
-35.03,
-22.28,
-12.97,
-0.08,
20.02,
39.23,
49.67,
58.37,
78.43,
108.22,
130.82,
136.24,
130.83,
123.90,
114.26,
96.05,
70.15,
43.76,
18.97,
-11.62,
-51.56,
-88.97,
-108.69,
-113.97,
-122.60,
-142.18,
-161.14,
-166.74,
-159.76,
-147.67,
-131.50,
-106.47,
-72.66,
-38.69,
-10.43,
19.02,
58.80,
103.57,
137.06,
152.97,
160.90,
170.19,
177.11,
172.37,
154.92,
132.43,
109.94,
83.07,
47.58,
10.08,
-18.91,
-40.53,
-65.24,
-95.42,
-121.12,
-134.68,
-140.28,
-145.26,
-149.06,
-144.96,
-130.56,
-111.34,
-92.43,
-70.72,
-41.40,
-8.61,
18.46,
39.37,
62.30,
89.69,
112.82,
123.38,
124.08,
123.68,
124.58,
120.13,
105.92,
88.06,
74.49,
61.57,
39.65,
10.00,
-15.14,
-30.38,
-44.49,
-66.82,
-93.72,
-113.44,
-120.73,
-121.55,
-121.96,
-118.09,
-103.37,
-81.56,
-62.63,
-46.70,
-24.24,
7.37,
37.22,
54.63,
61.92,
69.37,
81.12,
90.85,
92.40,
88.68,
85.53,
80.26,
66.52,
48.02,
35.94,
31.79,
24.00,
3.96,
-22.14,
-41.74,
-50.89,
-56.34,
-63.73,
-69.60,
-69.17,
-66.71,
-68.66,
-69.29,
-56.70,
-32.18,
-11.97,
-6.87,
-9.90,
-7.72,
2.67,
13.64,
20.01,
25.47,
33.98,
39.94,
36.94,
31.86,
38.17,
55.33,
66.97,
61.82,
46.83,
36.13,
33.77,
32.67,
26.59,
17.35,
7.99,
-5.09,
-25.37,
-44.18,
-47.64,
-36.56,
-30.04,
-45.00,
-75.31,
-97.19,
-94.76,
-75.35,
-56.24,
-43.13,
-30.28,
-16.90,
-7.31,
3.50,
25.66,
55.66,
76.49,
80.21,
77.13,
79.33,
84.88,
83.62,
72.16,
56.84,
43.08,
27.10,
4.25,
-19.83,
-34.91,
-41.78,
-50.49,
-63.94,
-73.45,
-72.96,
-67.64,
-65.00,
-63.89,
-56.78,
-41.10,
-23.03,
-8.68,
4.68,
22.09,
39.83,
49.28,
51.28,
55.41,
64.50,
69.06,
60.13,
41.54,
24.69,
14.91,
6.78,
-5.24,
-17.85,
-25.17,
-30.11,
-38.65,
-45.69,
-39.73,
-21.57,
-6.76,
-6.01,
-12.82,
-13.71,
-5.26,
4.87,
10.60,
14.82,
20.58,
21.38,
11.13,
-0.24,
3.96,
23.00,
36.82,
30.87,
12.16,
-2.97,
-8.58,
-10.99,
-15.92,
-20.99,
-22.98,
-26.75,
-37.00,
-45.56,
-39.26,
-19.52,
-2.23,
3.14,
2.76,
5.05,
8.61,
8.07,
5.01,
6.54,
13.93,
18.33,
13.76,
8.82,
15.87,
31.18,
37.78,
28.46,
14.26,
8.00,
8.80,
7.36,
0.12,
-7.78,
-11.77,
-14.93,
-21.00,
-25.16,
-20.20,
-9.52,
-4.36,
-7.40,
-9.47,
-3.62,
5.30,
8.91,
6.97,
6.41,
10.27,
12.76,
8.47,
2.29,
2.64,
7.51,
6.84,
-1.82,
-9.67,
-10.53,
-9.53,
-14.91,
-25.89,
-33.90,
-34.14,
-31.60,
-31.92,
-31.44,
-22.99,
-9.13,
0.83,
5.94,
14.93,
31.37,
46.85,
52.56,
50.58,
49.77,
53.16,
54.62,
48.99,
40.33,
34.29,
26.82,
10.90,
-8.01,
-16.59,
-13.71,
-13.56,
-26.39,
-45.86,
-59.17,
-62.78,
-62.89,
-63.87,
-62.64,
-56.58,
-51.62,
-53.11,
-53.29,
-40.25,
-17.17,
0.28,
5.70,
6.58,
7.47,
5.77,
-0.22,
-11.51,
-35.70,
-69.03,
-80.28,
-39.65,
35.59,
92.58,
101.23,
79.57,
59.08,
49.29,
43.13,
36.01,
28.71,
22.77,
17.72,
13.50,
10.06,
7.32,
5.21,
3.62,
2.41,
1.45,
0.68,
0.17,
-0.05,
-0.05,
-0.00,
0.02,
0.01,
-0.00,
-0.00};

// Filter coefficient
const float bandpass_coef[B_PASS_COEF]= {0.000005886298855362,
                          -0.000003150867128908,
                          -0.000036667688162528,
                          -0.000040375108069883,
                           0.000078181727907654,
                           0.000216019926945927,
                          -0.000011251169284801,
                          -0.000891299843146648,
                          -0.002212041983057407,
                          -0.003485522153665982,
                          -0.004564611123480812,
                          -0.005804814082860685,
                          -0.007608403130103518,
                          -0.010046976179291432,
                          -0.012973937943450840,
                          -0.016270189327745838,
                          -0.019866894878019171,
                          -0.023690985585235982,
                          -0.027630905011080505,
                          -0.033446454002452636,
                          -0.032327282078347716,
                          -0.028162531266924459,
                          -0.042268849108335449,
                          -0.085994300152352779,
                          -0.092079424253997205,
                           0.031932069200080390,
                           0.242253563611250111,
                           0.349862292342303483,
                           0.242253563611251332,
                           0.031932069200080161,
                          -0.092079424253996983,
                          -0.085994300152352876,
                          -0.042268849108335442,
                          -0.028162531266924411,
                          -0.032327282078347647,
                          -0.033446454002452636,
                          -0.027630905011080578,
                          -0.023690985585236080,
                          -0.019866894878019230,
                          -0.016270189327745883,
                          -0.012973937943450843,
                          -0.010046976179291438,
                          -0.007608403130103532,
                          -0.005804814082860715,
                          -0.004564611123480853,
                          -0.003485522153666005,
                          -0.002212041983057406,
                          -0.000891299843146665,
                          -0.000011251169284819,
                           0.000216019926945917,
                           0.000078181727907637,
                          -0.000040375108069875,
                          -0.000036667688162510,
                          -0.000003150867128906,
                           0.000005886298855359};

void IRAM_ATTR ISR()
{
  cnt++;
  if(cnt >= BURST_PULSE)
  {
    ledcWrite(PWM_CHANNEL,0);   
    cnt= 0;
  }
}

void i2sInit()
{
  i2s_config_t i2s_config =
  {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX | I2S_MODE_ADC_BUILT_IN),
    .sample_rate =  I2S_SAMPLE_RATE,              // The format of the signal using ADC_BUILT_IN
    .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT, // is fixed at 12bit, stereo, MSB
    .channel_format = I2S_CHANNEL_FMT_RIGHT_LEFT,
    .communication_format = I2S_COMM_FORMAT_STAND_I2S,
    .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
    .dma_buf_count = 8,
    .dma_buf_len = I2S_DMA_BUF_LEN,
    .use_apll = false,
    .tx_desc_auto_clear = false,
    .fixed_mclk = 0
  };

  i2s_driver_install(I2S_NUM_0, &i2s_config, 0, NULL);
  i2s_set_adc_mode(ADC_UNIT_1, ADC_INPUT);
  adc1_config_channel_atten(ADC_INPUT, ADC_ATTEN_DB_11);
  i2s_adc_enable(I2S_NUM_0);
}

void setup()
{
  Serial.begin(BAUDRATE);
  cnt = 0;
  
  // PWM init
  ledcSetup(PWM_CHANNEL,PWM_FREQ,PWM_BITS);
  ledcAttachPin(PWM_PIN,PWM_CHANNEL);
  ledcWrite(PWM_CHANNEL,PWM_DUTY);

  // Interrupt init
  attachInterrupt(digitalPinToInterrupt(INT_PIN),ISR,FALLING);
  
  prev = ESP.getCycleCount();
  
  // WiFi & ThingSpeak init
  // WiFi.mode(WIFI_STA);
  // ThingSpeak.begin(client);

  // I2S ADC DMA init
  i2sInit();
}

void loop()
{
  // Connect or reconnect to WiFi
  // if(WiFi.status() != WL_CONNECTED)
  // {
  //   Serial.print("Attempting to connect to SSID: ");
  //   Serial.println(SECRET_SSID);
  //   while(WiFi.status() != WL_CONNECTED)
  //   {
  //     WiFi.begin(ssid, pass);  // Connect to WPA/WPA2 network. Change this line if using open or WEP network
  //     Serial.print(".");
  //     delay(5000);     
  //   } 
  //   Serial.println("\nConnected.");
  // }

  // Read ADC value
  for(int i = 0; i < I2S_DMA_BUF_ARR; i++)
  {
    i2s_read(I2S_NUM_0, &buffer[i], sizeof(buffer[i]), &bytes_read, portMAX_DELAY);
  }
  curr = ESP.getCycleCount();
  i2s_adc_disable(I2S_NUM_0);

  // Flatten 2 dimension array and convert into voltage
  for(int i = 0; i < I2S_DMA_BUF_ARR; i++)
  {
    for(int j = 0; j < (I2S_DMA_BUF_LEN + 0); j++)
    {
      buff[(i * I2S_DMA_BUF_LEN) + j] = map(buffer[i][j]&0x0fff, 0, 4095, (-1650), 1650);
    }
  }

  // Band-pass filter
  for(int i = 0; i < I2S_DMA_BUF_FLATTEN; i++)
  {
    float conv = 0;
    for(int j = 0; j < B_PASS_COEF; j++) conv += buff[i+j] * bandpass_coef[j];
    buff_filtered[i] = conv;
  }

  // Feature extraction
  #ifdef FEATURE_EXTRACT
    // Peak
    int peak = 0;
    for(int i = 0; i < I2S_DMA_BUF_FLATTEN; i++)
    {
      if(abs(buff[i]) > peak) peak = buff[i];
    }
   
    // Mean
    float sum = 0;
    for(int i = 0; i < I2S_DMA_BUF_FLATTEN; i++) sum += buff[i];
    miu = (float)(sum/I2S_DMA_BUF_FLATTEN);

    // Variance
    sum = 0;
    for(int i = 0; i < I2S_DMA_BUF_FLATTEN; i++) sum += pow(buff[i] - miu, 2);
    sigma_sqr = (float)(sum/I2S_DMA_BUF_FLATTEN);

    // Time of Flight
    int n = 0;
    float tmp = 0;
    for(int i = 0; i < I2S_DMA_BUF_FLATTEN; i++)
    {
      sum = 0;
      for(int j = 0; j < I2S_DMA_BUF_FLATTEN; j++)
      {
        if((i + j) < I2S_DMA_BUF_FLATTEN) sum += buff_filtered[j] * ref_signal[i + j];

        if(sum > tmp)
        {
          tmp = sum;
          n = i;
        }
      }
    }
    tetha = (n * I2S_TS);

    // Print parameter
    Serial.printf("peak;%d;mean;%.2f;var;%.2f;tof;%d\n", peak, miu, sigma_sqr, tetha);
    
    // #ifdef IOT
    //   ThingSpeak.setField(1, peak);
    //   ThingSpeak.setField(2, miu);
    //   ThingSpeak.setField(3, sigma_sqr);
    //   ThingSpeak.setField(4, tetha);
    //   // ThingSpeak.setField(5, dmg_index);

    //   int x = ThingSpeak.writeFields(myChannelNumber, myWriteAPIKey);

    //   // if(x == 200) Serial.println("Channel update successful.");
    //   // else Serial.println("Problem updating channel. HTTP error code " + String(x));
    // #endif
  #endif

  // Print features
  Serial.printf("peak;%d;mean;%.f;variance;%.f;tof;%d", peak, miu, sigma_sqr, tetha);

  // Print signal
  for(int i = 0; i < I2S_DMA_BUF_FLATTEN; i++)
  {
    Serial.printf("%.2f\n", (buff_filtered[i]));
  }

  delay(1000);
  prev = ESP.getCycleCount();
  i2s_adc_enable(I2S_NUM_0);
  ledcWrite(PWM_CHANNEL, PWM_DUTY);
}